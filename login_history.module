<?php

/**
 * @file
 * The login history module.
 */

/**
 * Implements hook_views_api().
 */
function login_history_views_api() {
  return array(
    'api' => '3.0',
    'path' => drupal_get_path('module', 'login_history') . '/views',
  );
}

/**
 * Implements hook_user_login().
 */
function login_history_user_login(&$edit, $account) {
  // Is this a one-time login?
  $menu_item = menu_get_item();
  if ('user/reset/%/%/%' == $menu_item['path']) {
    $one_time = 1;
  }
  else {
    $one_time = 0;
  }

  // Validate and parse the cookie.
  module_load_include('inc', 'login_history', 'login_history');
  try {
    $old_device_id = login_history_get_device_id_from_cookie($_COOKIE, drupal_get_hash_salt());
  }
  catch (Exception $e) {
    $old_device_id = '';
    watchdog_exception('login_history', $e);
  }

  // Perform some default gathering of info about the login event.
  $detection = array(
    'user_agent' => empty($_SERVER['HTTP_USER_AGENT']) ? '' : $_SERVER['HTTP_USER_AGENT'],
  );

  // Allow other modules to add more info to the detection.
  drupal_alter('login_history_detect_device', $detection, $edit, $account);

  // Have a consistent order for the hash.
  asort($detection);
  $device_id = hash('sha256', implode('', $detection));

  // Limit user agent strings to 255 characters. If a module cares about more
  // (or less) data, it should create it's own schema and store the agent there.

  // Now save the user's current login timestamp to login_history.
  $login_id = db_insert('login_history')
    ->fields(array(
      'uid' => $account->uid,
      'login' => $account->login,
      'hostname' => ip_address(),
      'one_time' => $one_time,
      'user_agent' => substr($detection['user_agent'], 0, 255),
      'device_id' => $device_id,
      'old_device_id' => $old_device_id,
    ))
    ->execute();

  // TODO: would be useful to load the prior login data here e.g. a change of IP address that is
  // still in the same geo location is less risky than a change of IP address across the world.

  $login_history_cookie = login_history_assemble_cookie($device_id, $login_id, drupal_get_hash_salt());
  user_cookie_save(array('login_history' => $login_history_cookie));

  module_invoke_all('login_history_detection_results', $login_id, $detection, $old_device_id, $device_id, $account);
}

/**
 * Implements hook_menu().
 */
function login_history_menu() {
  $items = array();
  $items['admin/reports/login-history'] = array(
    'title' => 'Login history',
    'description' => 'Shows previous login information for site users. Useful for troubleshooting and monitoring.',
    'page callback' => 'login_history_report_callback',
    'access arguments' => array('administer users'),
    'file' => 'includes/login_history.pages.inc',
  );
  $items['user/%user/login-history'] = array(
    'title' => 'Login history',
    'description' => '',
    'page callback' => 'login_history_report_callback',
    'page arguments' => array(1),
    'access callback' => 'login_history_access_user_history_page',
    'access arguments' => array(1),
    'type' => MENU_LOCAL_TASK,
    'file' => 'includes/login_history.pages.inc',
  );
  return $items;
}

/**
 * Implements hook_permission().
 */
function login_history_permission() {
  return array(
    'view own login history' => array(
      'title' => t('View own login history'),
    ),
    'view all login histories' => array(
      'title' => t('View all login histories'),
    ));
}

/**
 * Access callback for the user-specific Login History page.
 *
 * @param object $account
 *   A user object.
 *
 * @return bool
 *   TRUE if the user can access the page.
 */
function login_history_access_user_history_page($account) {
  return ($account->uid == $GLOBALS['user']->uid && user_access('view own login history')) || user_access('view all login histories');
}

/**
 * Implements hook_block_info().
 */
function login_history_block_info() {
  // Show their last login info.
  $blocks['login_history_last']['info'] = t("Last login");
  $blocks['login_history_last']['properties']['administrative'] = TRUE;
  $blocks['login_history_last']['cache'] = DRUPAL_CACHE_PER_USER;

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function login_history_block_view($delta = '') {
  switch ($delta) {
    case 'login_history_last':
      if (user_is_anonymous()) {
        return;
      }
      // Get information about the user's last login. If no information is
      // found, the block is not displayed.
      if ($last_login = login_history_last_login()) {
        $hostname = $last_login->hostname == ip_address() ? t('this IP address') : $last_login->hostname;
        $user_agent = $last_login->user_agent == $_SERVER['HTTP_USER_AGENT'] ? t('this browser') : $last_login->user_agent;
        $output = '<p>' . t('You last logged in from @hostname using @user_agent.', array('@hostname' => $hostname, '@user_agent' => $user_agent)) . '</p>';
        if (user_access('view own login history')) {
          global $user;
          $output .= '<span class="read-more">' . l(t('View your login history.'), 'user/' . $user->uid . '/login-history') . '</span>';
        }

        $block['subject'] = t('Last login');
        $block['content'] = $output;
        return $block;
      }
  }
}

/**
 * Provide data about the last login for a user.
 *
 * @param object $account
 *   Optional user object. The only thing that really matters is the uid.
 *
 * @return object|false
 *   An object containing information about the last login or FALSE if no
 *   result is found.
 */
function login_history_last_login($account = NULL) {
  if (user_is_anonymous()) {
    return;
  }
  if (empty($account)) {
    global $user;
    $account = $user;
  }
  $last_login = db_query("SELECT login, hostname, one_time, user_agent
                   FROM {login_history}
                   WHERE uid = :uid
                   ORDER BY login DESC
                   LIMIT 1, 2", array(':uid' => $account->uid))->fetchAll();
  return reset($last_login);
}
